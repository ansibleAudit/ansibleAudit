---
# Copyright (c) 2024 Marc Serrano
#
# This file is part of the terms of the GNU General Public License (GPL).
# See https://www.gnu.org/licenses/gpl-3.0.html for more details.

- name: Ensure permissions on /etc/passwd are configured 
  hosts: localhost
  vars:
     remediation_commands:
        - "chown root:root /etc/passwd"
        - "chmod u-x,go-wx /etc/passwd"
     expected_uid: 0
     expected_gid: 0
     expected_mode: "0644"
     
  tasks:
     - name: Include OS-specific variables
       include_vars: "../../common/vars/global_vars.yml"
          
     - name: Check current permissions and ownership of /etc/passwd
       include_tasks: ../../common/tasks/check_passwd_file.yml
       vars:
          passwd: "{{ passwd_file }}"
       register: passwd_stat
          
     - name: Fail if ownership or permissions on /etc/passwd are not correct
       ansible.builtin.fail:
          msg: "[Remediation]{{ remediation_commands }}"
       when:
          - passwd_stat.stat.uid != expected_uid
          - passwd_stat.stat.gid != expected_gid
          - passwd_stat.stat.mode != expected_mode
